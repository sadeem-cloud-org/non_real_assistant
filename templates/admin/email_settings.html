{% extends "base.html" %}

{% block title %}{{ t('إعدادات البريد الإلكتروني') }}{% endblock %}

{% block page_title %}{{ t('إعدادات البريد الإلكتروني') }}{% endblock %}
{% block page_subtitle %}{{ t('إعدادات خادم SMTP لإرسال البريد الإلكتروني') }}{% endblock %}

{% block page_actions %}
<a href="/admin" class="btn btn-outline-secondary">
    <i class="ti ti-arrow-right me-2"></i>
    {{ t('العودة') }}
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ t('إعدادات SMTP') }}</h3>
            </div>
            <div class="card-body">
                <form id="emailSettingsForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">{{ t('خادم SMTP') }}</label>
                                <input type="text" class="form-control" name="smtp_host"
                                       placeholder="smtp.gmail.com" dir="ltr">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">{{ t('المنفذ') }}</label>
                                <input type="number" class="form-control" name="smtp_port"
                                       placeholder="587" dir="ltr">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-check">
                            <input class="form-check-input" type="checkbox" name="smtp_use_tls" checked>
                            <span class="form-check-label">{{ t('استخدام TLS') }}</span>
                        </label>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{{ t('اسم المستخدم') }}</label>
                                <input type="text" class="form-control" name="smtp_user"
                                       placeholder="user@gmail.com" dir="ltr">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{{ t('كلمة المرور') }}</label>
                                <input type="password" class="form-control" name="smtp_password"
                                       placeholder="{{ t('اتركه فارغاً للإبقاء على القيمة الحالية') }}" dir="ltr">
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{{ t('البريد المرسل') }}</label>
                                <input type="email" class="form-control" name="from_email"
                                       placeholder="noreply@example.com" dir="ltr">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">{{ t('اسم المرسل') }}</label>
                                <input type="text" class="form-control" name="from_name"
                                       placeholder="Non Real Assistant">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-device-floppy me-2"></i>
                            {{ t('حفظ الإعدادات') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ t('اختبار الإعدادات') }}</h3>
            </div>
            <div class="card-body">
                <form id="testEmailForm">
                    <div class="mb-3">
                        <label class="form-label">{{ t('بريد الاختبار') }}</label>
                        <input type="email" class="form-control" name="test_email"
                               placeholder="test@example.com" dir="ltr" required>
                        <small class="form-hint">{{ t('سيتم إرسال رسالة اختبار لهذا البريد') }}</small>
                    </div>
                    <button type="submit" class="btn btn-outline-primary w-100" id="testButton">
                        <i class="ti ti-send me-2"></i>
                        {{ t('إرسال رسالة اختبار') }}
                    </button>
                </form>

                <div class="mt-3" id="testResult" style="display: none;">
                    <div class="alert" role="alert">
                        <span id="testResultText"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">{{ t('ملاحظات') }}</h3>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="ti ti-info-circle text-blue me-2"></i>
                        {{ t('Gmail: استخدم كلمة مرور التطبيقات') }}
                    </li>
                    <li class="mb-2">
                        <i class="ti ti-info-circle text-blue me-2"></i>
                        {{ t('المنفذ 587 مع TLS أو 465 بدون TLS') }}
                    </li>
                    <li class="mb-2">
                        <i class="ti ti-info-circle text-blue me-2"></i>
                        {{ t('تأكد من تفعيل SMTP في إعدادات البريد') }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
// Load current settings
function loadSettings() {
    fetch('/api/system/email-settings')
        .then(r => r.json())
        .then(data => {
            const form = document.getElementById('emailSettingsForm');
            form.elements['smtp_host'].value = data.smtp_host || '';
            form.elements['smtp_port'].value = data.smtp_port || 587;
            form.elements['smtp_use_tls'].checked = data.smtp_use_tls !== false;
            form.elements['smtp_user'].value = data.smtp_user || '';
            form.elements['from_email'].value = data.from_email || '';
            form.elements['from_name'].value = data.from_name || 'Non Real Assistant';
        });
}

// Save settings
document.getElementById('emailSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
        smtp_host: formData.get('smtp_host'),
        smtp_port: parseInt(formData.get('smtp_port')) || 587,
        smtp_use_tls: formData.get('smtp_use_tls') === 'on',
        smtp_user: formData.get('smtp_user'),
        smtp_password: formData.get('smtp_password'),
        from_email: formData.get('from_email'),
        from_name: formData.get('from_name')
    };

    fetch('/api/system/email-settings', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showResult('success', '{{ t("تم حفظ الإعدادات بنجاح") }}');
                // Clear password field after save
                this.elements['smtp_password'].value = '';
            } else {
                showResult('danger', result.error || '{{ t("حدث خطأ") }}');
            }
        });
});

// Test email
document.getElementById('testEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const testEmail = this.elements['test_email'].value;
    const settingsForm = document.getElementById('emailSettingsForm');

    const data = {
        test_email: testEmail,
        smtp_host: settingsForm.elements['smtp_host'].value,
        smtp_port: parseInt(settingsForm.elements['smtp_port'].value) || 587,
        smtp_use_tls: settingsForm.elements['smtp_use_tls'].checked,
        smtp_user: settingsForm.elements['smtp_user'].value,
        smtp_password: settingsForm.elements['smtp_password'].value,
        from_email: settingsForm.elements['from_email'].value,
        from_name: settingsForm.elements['from_name'].value
    };

    const btn = document.getElementById('testButton');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ t("جاري الإرسال...") }}';

    fetch('/api/system/email-test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showResult('success', '{{ t("تم إرسال رسالة الاختبار بنجاح") }}');
            } else {
                showResult('danger', result.error || '{{ t("فشل إرسال الرسالة") }}');
            }
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-send me-2"></i>{{ t("إرسال رسالة اختبار") }}';
        });
});

function showResult(type, message) {
    const resultDiv = document.getElementById('testResult');
    const resultText = document.getElementById('testResultText');

    resultDiv.style.display = 'block';
    resultDiv.querySelector('.alert').className = `alert alert-${type}`;
    resultText.textContent = message;

    setTimeout(() => {
        resultDiv.style.display = 'none';
    }, 5000);
}

// Initial load
document.addEventListener('DOMContentLoaded', loadSettings);
</script>
{% endblock %}
