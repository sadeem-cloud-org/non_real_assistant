{% extends "base.html" %}

{% block title %}إدارة الترجمات - Non Real Assistant{% endblock %}

{% block page_title %}إدارة الترجمات{% endblock %}
{% block page_subtitle %}إدارة اللغات والترجمات{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showAddLanguageModal()">
    <i class="ti ti-plus"></i>
    إضافة لغة
</button>
{% endblock %}

{% block content %}
<div class="row row-deck row-cards">
    <!-- Languages List -->
    <div class="col-12 col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">اللغات</h3>
            </div>
            <div class="list-group list-group-flush" id="languages-list">
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translations -->
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" id="translations-title">اختر لغة</h3>
                <div class="card-actions" id="translation-actions" style="display: none;">
                    <button class="btn btn-ghost-primary btn-sm" onclick="syncStrings()">
                        <i class="ti ti-refresh"></i>
                        مزامنة النصوص
                    </button>
                    <button class="btn btn-ghost-success btn-sm" onclick="exportTranslations()">
                        <i class="ti ti-download"></i>
                        تصدير .po
                    </button>
                    <button class="btn btn-ghost-warning btn-sm" onclick="showImportModal()">
                        <i class="ti ti-upload"></i>
                        استيراد .po
                    </button>
                </div>
            </div>
            <div class="card-body" id="translations-content">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-language icon"></i>
                    </div>
                    <p class="empty-title">اختر لغة من القائمة</p>
                    <p class="empty-subtitle text-muted">
                        اختر لغة لعرض وتحرير الترجمات الخاصة بها
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Language Modal -->
<div class="modal" id="modal-add-language" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة لغة جديدة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">اسم اللغة</label>
                    <input type="text" class="form-control" id="new-lang-name" placeholder="مثال: English">
                </div>
                <div class="mb-3">
                    <label class="form-label">رمز اللغة (ISO 639-1)</label>
                    <input type="text" class="form-control" id="new-lang-code" placeholder="مثال: en" maxlength="5">
                    <small class="text-muted">رمز اللغة مثل: en, fr, de, es</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="addLanguage()">إضافة</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal" id="modal-import" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">استيراد ملف ترجمة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ملف .po</label>
                    <input type="file" class="form-control" id="import-file" accept=".po">
                </div>
                <div class="alert alert-info">
                    <i class="ti ti-info-circle"></i>
                    سيتم تحديث الترجمات الموجودة وإضافة الجديدة
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="importTranslations()">استيراد</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Translation Modal -->
<div class="modal" id="modal-edit-translation" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تحرير الترجمة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">النص الأصلي</label>
                    <div class="form-control-plaintext bg-light p-2 rounded" id="edit-original" dir="auto"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">الترجمة</label>
                    <textarea class="form-control" id="edit-value" rows="3" dir="auto"></textarea>
                </div>
                <input type="hidden" id="edit-translation-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="saveTranslation()">حفظ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let currentLanguageId = null;
let translations = [];

document.addEventListener('DOMContentLoaded', function() {
    loadLanguages();
});

async function loadLanguages() {
    try {
        const response = await fetch('/api/translations/languages');
        const languages = await response.json();

        const container = document.getElementById('languages-list');
        if (languages.length === 0) {
            container.innerHTML = `
                <div class="empty p-3">
                    <p class="empty-title">لا توجد لغات</p>
                </div>
            `;
            return;
        }

        container.innerHTML = languages.map(lang => `
            <a href="#" class="list-group-item list-group-item-action ${currentLanguageId === lang.id ? 'active' : ''}"
               onclick="selectLanguage(${lang.id}, '${lang.name}'); return false;">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">${lang.name}</h5>
                    <small class="text-muted">${lang.iso_code}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small>
                        <span class="badge bg-blue">${lang.translated_count}</span> /
                        <span>${lang.total_strings}</span> مترجم
                    </small>
                    ${lang.iso_code !== 'ar' ? `
                        <button class="btn btn-ghost-danger btn-sm" onclick="deleteLanguage(${lang.id}, event)">
                            <i class="ti ti-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </a>
        `).join('');
    } catch (error) {
        console.error('Error loading languages:', error);
    }
}

async function selectLanguage(languageId, languageName) {
    currentLanguageId = languageId;
    document.getElementById('translations-title').textContent = `ترجمات ${languageName}`;
    document.getElementById('translation-actions').style.display = 'flex';

    // Update active state
    document.querySelectorAll('#languages-list .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');

    // Load translations
    await loadTranslations(languageId);
}

async function loadTranslations(languageId) {
    const container = document.getElementById('translations-content');
    container.innerHTML = `
        <div class="text-center p-3">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    `;

    try {
        const response = await fetch(`/api/translations/${languageId}`);
        translations = await response.json();

        if (translations.length === 0) {
            container.innerHTML = `
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-file-text icon"></i>
                    </div>
                    <p class="empty-title">لا توجد نصوص</p>
                    <p class="empty-subtitle text-muted">
                        اضغط على "مزامنة النصوص" لاستخراج النصوص من القوالب
                    </p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-vcenter">
                    <thead>
                        <tr>
                            <th style="width: 45%">النص الأصلي</th>
                            <th style="width: 45%">الترجمة</th>
                            <th style="width: 10%">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${translations.map(t => `
                            <tr>
                                <td dir="auto" class="text-truncate" style="max-width: 300px;" title="${escapeHtml(t.key)}">
                                    ${escapeHtml(t.key.substring(0, 50))}${t.key.length > 50 ? '...' : ''}
                                </td>
                                <td dir="auto" class="${t.value ? '' : 'text-muted'}">
                                    ${t.value ? escapeHtml(t.value.substring(0, 50)) + (t.value.length > 50 ? '...' : '') : '<em>غير مترجم</em>'}
                                </td>
                                <td>
                                    <button class="btn btn-ghost-primary btn-sm" onclick="editTranslation(${t.id})">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading translations:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                حدث خطأ في تحميل الترجمات
            </div>
        `;
    }
}

function editTranslation(translationId) {
    const trans = translations.find(t => t.id === translationId);
    if (!trans) return;

    document.getElementById('edit-original').textContent = trans.key;
    document.getElementById('edit-value').value = trans.value || '';
    document.getElementById('edit-translation-id').value = translationId;

    const modal = new bootstrap.Modal(document.getElementById('modal-edit-translation'));
    modal.show();
}

async function saveTranslation() {
    const translationId = document.getElementById('edit-translation-id').value;
    const value = document.getElementById('edit-value').value;

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: parseInt(translationId), value })
        });

        const result = await response.json();
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('modal-edit-translation')).hide();
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'حدث خطأ');
        }
    } catch (error) {
        console.error('Error saving translation:', error);
        alert('حدث خطأ في الحفظ');
    }
}

function showAddLanguageModal() {
    document.getElementById('new-lang-name').value = '';
    document.getElementById('new-lang-code').value = '';
    const modal = new bootstrap.Modal(document.getElementById('modal-add-language'));
    modal.show();
}

async function addLanguage() {
    const name = document.getElementById('new-lang-name').value.trim();
    const code = document.getElementById('new-lang-code').value.trim().toLowerCase();

    if (!name || !code) {
        alert('الرجاء إدخال اسم اللغة ورمزها');
        return;
    }

    try {
        const response = await fetch('/api/translations/languages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, iso_code: code })
        });

        const result = await response.json();
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('modal-add-language')).hide();
            await loadLanguages();
        } else {
            alert(result.error || 'حدث خطأ');
        }
    } catch (error) {
        console.error('Error adding language:', error);
        alert('حدث خطأ في الإضافة');
    }
}

async function deleteLanguage(languageId, event) {
    event.stopPropagation();

    if (!confirm('هل أنت متأكد من حذف هذه اللغة وجميع ترجماتها؟')) {
        return;
    }

    try {
        const response = await fetch(`/api/translations/languages/${languageId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
            if (currentLanguageId === languageId) {
                currentLanguageId = null;
                document.getElementById('translations-title').textContent = 'اختر لغة';
                document.getElementById('translation-actions').style.display = 'none';
                document.getElementById('translations-content').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <i class="ti ti-language icon"></i>
                        </div>
                        <p class="empty-title">اختر لغة من القائمة</p>
                    </div>
                `;
            }
            await loadLanguages();
        } else {
            alert(result.error || 'حدث خطأ');
        }
    } catch (error) {
        console.error('Error deleting language:', error);
        alert('حدث خطأ في الحذف');
    }
}

async function syncStrings() {
    if (!currentLanguageId) return;

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}/sync`, {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            alert(`تمت المزامنة: ${result.added} نص جديد من أصل ${result.total_strings}`);
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'حدث خطأ');
        }
    } catch (error) {
        console.error('Error syncing:', error);
        alert('حدث خطأ في المزامنة');
    }
}

function exportTranslations() {
    if (!currentLanguageId) return;
    window.location.href = `/api/translations/${currentLanguageId}/export`;
}

function showImportModal() {
    if (!currentLanguageId) return;
    document.getElementById('import-file').value = '';
    const modal = new bootstrap.Modal(document.getElementById('modal-import'));
    modal.show();
}

async function importTranslations() {
    if (!currentLanguageId) return;

    const fileInput = document.getElementById('import-file');
    if (!fileInput.files.length) {
        alert('الرجاء اختيار ملف');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}/import`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('modal-import')).hide();
            alert(`تم الاستيراد: ${result.imported} جديد، ${result.updated} محدث`);
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'حدث خطأ');
        }
    } catch (error) {
        console.error('Error importing:', error);
        alert('حدث خطأ في الاستيراد');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
