{% extends "base.html" %}

{% block title %}{{ t('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª') }} - Non Real Assistant{% endblock %}

{% block page_title %}{{ t('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª') }}{% endblock %}
{% block page_subtitle %}{{ t('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ØºØ§Øª ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø§Øª') }}{% endblock %}

{% block page_actions %}
<button class="btn btn-outline-success me-2" onclick="loadFromFiles()">
    <i class="ti ti-folder-open"></i>
    {{ t('ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª') }}
</button>
<button class="btn btn-primary" onclick="showAddLanguageModal()">
    <i class="ti ti-plus"></i>
    {{ t('Ø¥Ø¶Ø§ÙØ© Ù„ØºØ©') }}
</button>
{% endblock %}

{% block content %}
<div class="row row-deck row-cards">
    <!-- Languages List -->
    <div class="col-12 col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ t('Ø§Ù„Ù„ØºØ§Øª') }}</h3>
            </div>
            <div class="list-group list-group-flush" id="languages-list">
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translations -->
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" id="translations-title">{{ t('Ø§Ø®ØªØ± Ù„ØºØ©') }}</h3>
                <div class="card-actions" id="translation-actions" style="display: none;">
                    <button class="btn btn-ghost-primary btn-sm" onclick="syncStrings()">
                        <i class="ti ti-refresh"></i>
                        {{ t('Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†ØµÙˆØµ') }}
                    </button>
                    <button class="btn btn-ghost-success btn-sm" onclick="exportTranslations()">
                        <i class="ti ti-download"></i>
                        {{ t('ØªØµØ¯ÙŠØ± .po') }}
                    </button>
                    <button class="btn btn-ghost-warning btn-sm" onclick="showImportModal()">
                        <i class="ti ti-upload"></i>
                        {{ t('Ø§Ø³ØªÙŠØ±Ø§Ø¯ .po') }}
                    </button>
                </div>
            </div>
            <div class="card-body" id="translations-content">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-language icon"></i>
                    </div>
                    <p class="empty-title">{{ t('Ø§Ø®ØªØ± Ù„ØºØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©') }}</p>
                    <p class="empty-subtitle text-muted">
                        {{ t('Ø§Ø®ØªØ± Ù„ØºØ© Ù„Ø¹Ø±Ø¶ ÙˆØªØ­Ø±ÙŠØ± Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§') }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Language Modal -->
<div class="modal" id="modal-add-language" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('Ø¥Ø¶Ø§ÙØ© Ù„ØºØ© Ø¬Ø¯ÙŠØ¯Ø©') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('Ø§Ø³Ù… Ø§Ù„Ù„ØºØ©') }}</label>
                    <input type="text" class="form-control" id="new-lang-name" placeholder="Ù…Ø«Ø§Ù„: English">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('Ø±Ù…Ø² Ø§Ù„Ù„ØºØ© (ISO 639-1)') }}</label>
                    <input type="text" class="form-control" id="new-lang-code" placeholder="{{ t('Ù…Ø«Ø§Ù„: en') }}" maxlength="5">
                    <small class="text-muted">{{ t('Ø±Ù…Ø² Ø§Ù„Ù„ØºØ© Ù…Ø«Ù„: en, fr, de, es') }}</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">{{ t('Ø¥Ù„ØºØ§Ø¡') }}</button>
                <button type="button" class="btn btn-primary" onclick="addLanguage()">{{ t('Ø¥Ø¶Ø§ÙØ©') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal" id="modal-import" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù ØªØ±Ø¬Ù…Ø©') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('Ù…Ù„Ù .po') }}</label>
                    <input type="file" class="form-control" id="import-file" accept=".po">
                </div>
                <div class="alert alert-info">
                    <i class="ti ti-info-circle"></i>
                    {{ t('Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">{{ t('Ø¥Ù„ØºØ§Ø¡') }}</button>
                <button type="button" class="btn btn-primary" onclick="importTranslations()">{{ t('Ø§Ø³ØªÙŠØ±Ø§Ø¯') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Translation Modal -->
<div class="modal" id="modal-edit-translation" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('ØªØ­Ø±ÙŠØ± Ø§Ù„ØªØ±Ø¬Ù…Ø©') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ') }}</label>
                    <div class="form-control-plaintext bg-light p-2 rounded" id="edit-original" dir="auto"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('Ø§Ù„ØªØ±Ø¬Ù…Ø©') }}</label>
                    <textarea class="form-control" id="edit-value" rows="3" dir="auto"></textarea>
                </div>
                <input type="hidden" id="edit-translation-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">{{ t('Ø¥Ù„ØºØ§Ø¡') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveTranslation()">{{ t('Ø­ÙØ¸') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let currentLanguageId = null;
let translations = [];

// Modal helper functions
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    modal.style.display = 'block';
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('role', 'dialog');
    modal.removeAttribute('aria-hidden');

    // Add backdrop
    let backdrop = document.getElementById(modalId + '-backdrop');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = modalId + '-backdrop';
        document.body.appendChild(backdrop);
    }
    document.body.classList.add('modal-open');

    // Close handlers
    const closeModal = () => hideModal(modalId);

    backdrop.onclick = closeModal;

    modal.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
        btn.onclick = closeModal;
    });
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    modal.removeAttribute('aria-modal');
    modal.removeAttribute('role');

    const backdrop = document.getElementById(modalId + '-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
    document.body.classList.remove('modal-open');
}

document.addEventListener('DOMContentLoaded', function() {
    loadLanguages();
});

async function loadLanguages() {
    try {
        const response = await fetch('/api/translations/languages');
        const languages = await response.json();

        const container = document.getElementById('languages-list');
        if (languages.length === 0) {
            container.innerHTML = `
                <div class="empty p-3">
                    <p class="empty-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„ØºØ§Øª</p>
                </div>
            `;
            return;
        }

        container.innerHTML = languages.map(lang => `
            <a href="#" class="list-group-item list-group-item-action ${currentLanguageId === lang.id ? 'active' : ''}"
               onclick="selectLanguage(${lang.id}, '${lang.name}'); return false;">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">${lang.name}</h5>
                    <small class="text-muted">${lang.iso_code}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small>
                        <span class="badge bg-blue">${lang.translated_count}</span> /
                        <span>${lang.total_strings}</span> {{ t('Ù…ØªØ±Ø¬Ù…') }}
                    </small>
                    ${lang.iso_code !== 'ar' ? `
                        <button class="btn btn-ghost-danger btn-sm" onclick="deleteLanguage(${lang.id}, event)">
                            <i class="ti ti-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </a>
        `).join('');
    } catch (error) {
        console.error('Error loading languages:', error);
    }
}

async function selectLanguage(languageId, languageName) {
    currentLanguageId = languageId;
    document.getElementById('translations-title').textContent = `ØªØ±Ø¬Ù…Ø§Øª ${languageName}`;
    document.getElementById('translation-actions').style.display = 'flex';

    // Update active state
    document.querySelectorAll('#languages-list .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');

    // Load translations
    await loadTranslations(languageId);
}

async function loadTranslations(languageId) {
    const container = document.getElementById('translations-content');
    container.innerHTML = `
        <div class="text-center p-3">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    `;

    try {
        const response = await fetch(`/api/translations/${languageId}`);
        translations = await response.json();

        if (translations.length === 0) {
            container.innerHTML = `
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-file-text icon"></i>
                    </div>
                    <p class="empty-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ</p>
                    <p class="empty-subtitle text-muted">
                        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†ØµÙˆØµ" Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
                    </p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-vcenter">
                    <thead>
                        <tr>
                            <th style="width: 45%">Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                            <th style="width: 45%">Ø§Ù„ØªØ±Ø¬Ù…Ø©</th>
                            <th style="width: 10%">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${translations.map(trans => `
                            <tr>
                                <td dir="auto" class="text-truncate" style="max-width: 300px;" title="${escapeHtml(trans.key)}">
                                    ${escapeHtml(trans.key.substring(0, 50))}${trans.key.length > 50 ? '...' : ''}
                                </td>
                                <td dir="auto" class="${trans.value ? '' : 'text-muted'}">
                                    ${trans.value ? escapeHtml(trans.value.substring(0, 50)) + (trans.value.length > 50 ? '...' : '') : '<em>ØºÙŠØ± Ù…ØªØ±Ø¬Ù…</em>'}
                                </td>
                                <td>
                                    <button class="btn btn-ghost-primary btn-sm" onclick="editTranslation(${trans.id})">
                                        <i class="ti ti-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading translations:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
            </div>
        `;
    }
}

function editTranslation(translationId) {
    const trans = translations.find(item => item.id === translationId);
    if (!trans) return;

    document.getElementById('edit-original').textContent = trans.key;
    document.getElementById('edit-value').value = trans.value || '';
    document.getElementById('edit-translation-id').value = translationId;

    showModal('modal-edit-translation');
}

async function saveTranslation() {
    const translationId = document.getElementById('edit-translation-id').value;
    const value = document.getElementById('edit-value').value;

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: parseInt(translationId), value })
        });

        const result = await response.json();
        if (result.success) {
            hideModal('modal-edit-translation');
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    } catch (error) {
        console.error('Error saving translation:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
    }
}

function showAddLanguageModal() {
    document.getElementById('new-lang-name').value = '';
    document.getElementById('new-lang-code').value = '';
    showModal('modal-add-language');
}

async function addLanguage() {
    const name = document.getElementById('new-lang-name').value.trim();
    const code = document.getElementById('new-lang-code').value.trim().toLowerCase();

    if (!name || !code) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù„ØºØ© ÙˆØ±Ù…Ø²Ù‡Ø§');
        return;
    }

    try {
        const response = await fetch('/api/translations/languages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, iso_code: code })
        });

        const result = await response.json();
        if (result.success) {
            hideModal('modal-add-language');
            await loadLanguages();
        } else {
            alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    } catch (error) {
        console.error('Error adding language:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    }
}

async function deleteLanguage(languageId, event) {
    event.stopPropagation();

    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ© ÙˆØ¬Ù…ÙŠØ¹ ØªØ±Ø¬Ù…Ø§ØªÙ‡Ø§ØŸ')) {
        return;
    }

    try {
        const response = await fetch(`/api/translations/languages/${languageId}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
            if (currentLanguageId === languageId) {
                currentLanguageId = null;
                document.getElementById('translations-title').textContent = 'Ø§Ø®ØªØ± Ù„ØºØ©';
                document.getElementById('translation-actions').style.display = 'none';
                document.getElementById('translations-content').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <i class="ti ti-language icon"></i>
                        </div>
                        <p class="empty-title">Ø§Ø®ØªØ± Ù„ØºØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                    </div>
                `;
            }
            await loadLanguages();
        } else {
            alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    } catch (error) {
        console.error('Error deleting language:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
    }
}

async function syncStrings() {
    if (!currentLanguageId) return;

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}/sync`, {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            alert(`ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${result.added} Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø£ØµÙ„ ${result.total_strings}`);
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    } catch (error) {
        console.error('Error syncing:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    }
}

function exportTranslations() {
    if (!currentLanguageId) return;
    window.location.href = `/api/translations/${currentLanguageId}/export`;
}

function showImportModal() {
    if (!currentLanguageId) return;
    document.getElementById('import-file').value = '';
    showModal('modal-import');
}

async function importTranslations() {
    if (!currentLanguageId) return;

    const fileInput = document.getElementById('import-file');
    if (!fileInput.files.length) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch(`/api/translations/${currentLanguageId}/import`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            hideModal('modal-import');
            alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${result.imported} Ø¬Ø¯ÙŠØ¯ØŒ ${result.updated} Ù…Ø­Ø¯Ø«`);
            await loadTranslations(currentLanguageId);
            await loadLanguages();
        } else {
            alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    } catch (error) {
        console.error('Error importing:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadFromFiles() {
    if (!confirm('Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù…Ù† Ù…Ù„ÙØ§Øª .po ÙÙŠ Ù…Ø¬Ù„Ø¯ translations.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
        return;
    }

    try {
        // Show loading
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

        const response = await fetch('/api/translations/load-from-files', {
            method: 'POST'
        });

        const result = await response.json();

        btn.disabled = false;
        btn.innerHTML = originalHtml;

        // Build result message
        let message = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª:\n\n`;
        message += `ğŸ“ Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${result.languages_processed}\n`;
        message += `âœ… ØªØ±Ø¬Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: ${result.total_imported}\n`;
        message += `ğŸ”„ ØªØ±Ø¬Ù…Ø§Øª Ù…Ø­Ø¯Ø«Ø©: ${result.total_updated}\n`;

        if (result.details && result.details.length > 0) {
            message += `\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n`;
            result.details.forEach(d => {
                if (d.status === 'success') {
                    message += `â€¢ ${d.file}: ${d.imported} Ø¬Ø¯ÙŠØ¯ØŒ ${d.updated} Ù…Ø­Ø¯Ø«\n`;
                } else if (d.status === 'skipped') {
                    message += `â€¢ ${d.file}: ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ - ${d.reason}\n`;
                }
            });
        }

        if (result.errors && result.errors.length > 0) {
            message += `\nâš ï¸ Ø£Ø®Ø·Ø§Ø¡:\n`;
            result.errors.forEach(e => {
                message += `â€¢ ${e}\n`;
            });
        }

        alert(message);

        // Reload languages
        await loadLanguages();
        if (currentLanguageId) {
            await loadTranslations(currentLanguageId);
        }

    } catch (error) {
        console.error('Error loading from files:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª');
    }
}
</script>
{% endblock %}
