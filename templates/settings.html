{% extends "base.html" %}

{% block title %}{{ t('الإعدادات') }} - Non Real Assistant{% endblock %}

{% block page_title %}{{ t('الإعدادات') }}{% endblock %}
{% block page_subtitle %}{{ t('إدارة حسابك وتفضيلاتك') }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Settings -->
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-user me-2"></i>
                    {{ t('الملف الشخصي') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('الاسم') }}</label>
                    <input type="text" class="form-control" id="user-name" placeholder="اسمك">
                </div>
                <div class="mb-3">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" class="form-control" id="user-email" placeholder="email@example.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">رقم الهاتف</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="user-phone" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="showChangePhone()">تغيير</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">معرف التليجرام</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="user-telegram" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="showChangeTelegram()">تغيير</button>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="saveProfile()">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- Preferences -->
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-settings me-2"></i>
                    التفضيلات
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">اللغة</label>
                    <select class="form-select" id="user-language">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">المنطقة الزمنية</label>
                    <select class="form-select" id="user-timezone">
                        <option value="Africa/Cairo">القاهرة (Africa/Cairo)</option>
                        <option value="Asia/Riyadh">الرياض (Asia/Riyadh)</option>
                        <option value="Asia/Dubai">دبي (Asia/Dubai)</option>
                        <option value="Europe/London">لندن (Europe/London)</option>
                        <option value="America/New_York">نيويورك (America/New_York)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-bell me-2"></i>
                    الإشعارات
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-check">
                        <input class="form-check-input" type="checkbox" id="notify-browser">
                        <span class="form-check-label">إشعارات المتصفح</span>
                    </label>
                    <small class="form-hint">إشعارات فورية في المتصفح</small>
                </div>
                <div class="alert alert-info">
                    <i class="ti ti-info-circle me-2"></i>
                    إشعارات التليجرام والبريد الإلكتروني يتم تحديدها لكل مساعد على حدة من صفحة المساعدين
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="savePreferences()">حفظ التفضيلات</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Settings (Admin Only) -->
{% if current_user and current_user.is_admin %}
<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-mail me-2"></i>
                    {{ t('إعدادات البريد الصادر') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('خادم SMTP') }}</label>
                            <input type="text" class="form-control" id="smtp-host" placeholder="smtp.gmail.com">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">{{ t('المنفذ') }}</label>
                            <input type="number" class="form-control" id="smtp-port" placeholder="587">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">{{ t('التشفير') }}</label>
                            <select class="form-select" id="smtp-security">
                                <option value="tls">TLS (Port 587)</option>
                                <option value="ssl">SSL (Port 465)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('اسم المستخدم / البريد') }}</label>
                            <input type="text" class="form-control" id="smtp-user" placeholder="user@example.com">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('كلمة المرور') }}</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="smtp-password" placeholder="••••••••">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('smtp-password')">
                                    <i class="ti ti-eye"></i>
                                </button>
                            </div>
                            <small class="form-hint">{{ t('لـ Gmail استخدم App Password') }}</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('البريد المرسل منه') }}</label>
                            <input type="email" class="form-control" id="smtp-from-email" placeholder="noreply@example.com">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('اسم المرسل') }}</label>
                            <input type="text" class="form-control" id="smtp-from-name" placeholder="Non Real Assistant">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">{{ t('بريد الاختبار') }}</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="test-email" placeholder="test@example.com">
                                <button class="btn btn-outline-primary" type="button" onclick="testEmailSettings()" id="btn-test-email">
                                    <i class="ti ti-send me-1"></i>
                                    {{ t('اختبار') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="email-test-result" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="saveEmailSettings()">
                    <i class="ti ti-device-floppy me-1"></i>
                    {{ t('حفظ إعدادات البريد') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Account Info -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-info-circle me-2"></i>
                    {{ t('معلومات الحساب') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">تاريخ التسجيل</label>
                            <div id="account-created"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">آخر تسجيل دخول</label>
                            <div id="account-last-login"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">رقم المستخدم</label>
                            <div id="account-id"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Change Phone Modal -->
<div class="modal fade" id="modal-change-phone" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تغيير رقم الهاتف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">رقم الهاتف الجديد</label>
                    <input type="tel" class="form-control" id="new-phone" placeholder="01234567890">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="changePhone()">تغيير</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Telegram Modal -->
<div class="modal fade" id="modal-change-telegram" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تغيير معرف التليجرام</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">معرف التليجرام الجديد</label>
                    <input type="text" class="form-control" id="new-telegram" placeholder="123456789">
                    <small class="form-hint">يمكنك الحصول على معرفك من @userinfobot</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="changeTelegram()">تغيير</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let userData = {};

document.addEventListener('DOMContentLoaded', loadUserProfile);

function loadUserProfile() {
    fetch('/api/user/profile')
        .then(r => r.json())
        .then(data => {
            userData = data;
            document.getElementById('user-name').value = data.name || '';
            document.getElementById('user-email').value = data.email || '';
            document.getElementById('user-phone').value = data.mobile || '';
            document.getElementById('user-telegram').value = data.telegram_id || '';

            // Handle language - can be object or id
            if (data.language && data.language.iso_code) {
                document.getElementById('user-language').value = data.language.iso_code;
            } else {
                document.getElementById('user-language').value = 'ar';
            }

            document.getElementById('user-timezone').value = data.timezone || 'Africa/Cairo';
            document.getElementById('notify-browser').checked = data.browser_notify;

            document.getElementById('account-id').textContent = '#' + data.id;
            document.getElementById('account-created').textContent = data.create_time ? new Date(data.create_time).toLocaleDateString('ar') : '-';
            document.getElementById('account-last-login').textContent = '-'; // TODO: get from login history
        });
}

function saveProfile() {
    const data = {
        name: document.getElementById('user-name').value,
        email: document.getElementById('user-email').value
    };

    fetch('/api/user/profile', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('تم حفظ الملف الشخصي بنجاح');
        } else {
            alert('خطأ: ' + (data.error || 'فشل الحفظ'));
        }
    });
}

function savePreferences() {
    // Get language id from iso_code
    const languageCode = document.getElementById('user-language').value;
    const languageIdMap = {'ar': 1, 'en': 2}; // Matching seed data

    const data = {
        language_id: languageIdMap[languageCode] || 1,
        timezone: document.getElementById('user-timezone').value,
        browser_notify: document.getElementById('notify-browser').checked
    };

    fetch('/api/user/profile', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        if (response.success) {
            alert('تم حفظ التفضيلات بنجاح');
            // Check if language changed
            const oldLang = userData.language ? userData.language.iso_code : 'ar';
            if (languageCode !== oldLang) {
                location.reload(); // Reload to apply language change
            }
        } else {
            alert('خطأ: ' + (response.error || 'فشل الحفظ'));
        }
    });
}

function showChangePhone() {
    document.getElementById('new-phone').value = '';
    new bootstrap.Modal(document.getElementById('modal-change-phone')).show();
}

function showChangeTelegram() {
    document.getElementById('new-telegram').value = '';
    new bootstrap.Modal(document.getElementById('modal-change-telegram')).show();
}

function changePhone() {
    const phone = document.getElementById('new-phone').value.trim();
    if (!phone) {
        alert('يرجى إدخال رقم الهاتف');
        return;
    }

    fetch('/api/user/phone', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({phone})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modal-change-phone')).hide();
            loadUserProfile();
            alert('تم تغيير رقم الهاتف بنجاح');
        } else {
            alert('خطأ: ' + (data.error || 'فشل التغيير'));
        }
    });
}

function changeTelegram() {
    const telegram_id = document.getElementById('new-telegram').value.trim();
    if (!telegram_id) {
        alert('يرجى إدخال معرف التليجرام');
        return;
    }

    fetch('/api/user/telegram', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({telegram_id})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('modal-change-telegram')).hide();
            loadUserProfile();
            alert('تم تغيير معرف التليجرام بنجاح');
        } else {
            alert('خطأ: ' + (data.error || 'فشل التغيير'));
        }
    });
}

// ===== Email Settings =====
function loadEmailSettings() {
    fetch('/api/system/email-settings')
        .then(r => r.json())
        .then(data => {
            if (data.error) return;
            document.getElementById('smtp-host').value = data.smtp_host || '';
            document.getElementById('smtp-port').value = data.smtp_port || 587;
            document.getElementById('smtp-security').value = data.smtp_use_tls ? 'tls' : 'ssl';
            document.getElementById('smtp-user').value = data.smtp_user || '';
            // Don't load password for security
            document.getElementById('smtp-from-email').value = data.from_email || '';
            document.getElementById('smtp-from-name').value = data.from_name || '';
        })
        .catch(() => {});
}

function saveEmailSettings() {
    const data = {
        smtp_host: document.getElementById('smtp-host').value,
        smtp_port: parseInt(document.getElementById('smtp-port').value) || 587,
        smtp_use_tls: document.getElementById('smtp-security').value === 'tls',
        smtp_user: document.getElementById('smtp-user').value,
        smtp_password: document.getElementById('smtp-password').value,
        from_email: document.getElementById('smtp-from-email').value,
        from_name: document.getElementById('smtp-from-name').value
    };

    fetch('/api/system/email-settings', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        if (response.success) {
            alert('تم حفظ إعدادات البريد بنجاح');
        } else {
            alert('خطأ: ' + (response.error || 'فشل الحفظ'));
        }
    });
}

function testEmailSettings() {
    const testEmail = document.getElementById('test-email').value.trim();
    if (!testEmail) {
        alert('يرجى إدخال بريد الاختبار');
        return;
    }

    const btn = document.getElementById('btn-test-email');
    const resultDiv = document.getElementById('email-test-result');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> جاري الإرسال...';
    resultDiv.innerHTML = '';

    // First save current settings, then test
    const data = {
        smtp_host: document.getElementById('smtp-host').value,
        smtp_port: parseInt(document.getElementById('smtp-port').value) || 587,
        smtp_use_tls: document.getElementById('smtp-security').value === 'tls',
        smtp_user: document.getElementById('smtp-user').value,
        smtp_password: document.getElementById('smtp-password').value,
        from_email: document.getElementById('smtp-from-email').value,
        from_name: document.getElementById('smtp-from-name').value,
        test_email: testEmail
    };

    fetch('/api/system/email-test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-send me-1"></i> اختبار';

        if (response.success) {
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>تم إرسال البريد بنجاح!</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (response.error || 'فشل الإرسال') + '</div>';
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-send me-1"></i> اختبار';
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>خطأ في الاتصال</div>';
    });
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Load email settings on page load if admin
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('smtp-host')) {
        loadEmailSettings();
    }
});
</script>
{% endblock %}
