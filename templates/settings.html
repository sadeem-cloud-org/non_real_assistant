{% extends "base.html" %}

{% block title %}Profile & Preferences - Non Real Assistant{% endblock %}

{% block page_title %}Profile & Preferences{% endblock %}
{% block page_subtitle %}Manage your profile and preferences{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Settings -->
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-user me-2"></i>
                    {{ t('الملف الشخصي') }}
                </h3>
            </div>
            <div class="card-body">
                <!-- Avatar Upload -->
                <div class="mb-4 text-center">
                    <div class="d-inline-block position-relative">
                        <div id="avatar-container">
                            {% if current_user and current_user.avatar %}
                            <span class="avatar avatar-xl" id="avatar-preview" style="width: 100px; height: 100px; background-image: url('/uploads/avatars/{{ current_user.avatar }}'); cursor: pointer;" onclick="document.getElementById('avatar-input').click()"></span>
                            {% else %}
                            <span class="avatar avatar-xl bg-primary-lt" id="avatar-preview" style="width: 100px; height: 100px; font-size: 36px; cursor: pointer;" onclick="document.getElementById('avatar-input').click()">
                                {{ (current_user.name[:1] if current_user and current_user.name else (current_user.mobile[-2:] if current_user else '')) | upper }}
                            </span>
                            {% endif %}
                        </div>
                        <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                        <button type="button" class="btn btn-icon btn-sm btn-primary position-absolute" style="bottom: 0; right: 0; border-radius: 50%;" onclick="document.getElementById('avatar-input').click()">
                            <i class="ti ti-camera"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">{{ t('اضغط لتغيير الصورة (الحد الأقصى 2MB)') }}</small>
                    </div>
                </div>
                <hr class="mb-3">
                <div class="mb-3">
                    <label class="form-label">{{ t('الاسم') }}</label>
                    <input type="text" class="form-control" id="user-name" placeholder="{{ t('اسمك') }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('البريد الإلكتروني') }}</label>
                    <input type="email" class="form-control" id="user-email" placeholder="email@example.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('رقم الهاتف') }}</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="user-phone" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="showChangePhone()">{{
                            t('تغيير') }}
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('معرف التليجرام') }}</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="user-telegram" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="showChangeTelegram()">{{
                            t('تغيير') }}
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="saveProfile()">{{ t('حفظ التغييرات') }}</button>
            </div>
        </div>
    </div>

    <!-- Preferences -->
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-settings me-2"></i>
                    {{ t('التفضيلات') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('اللغة') }}</label>
                    <select class="form-select" id="user-language">
                        <option value="ar">العربية</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('المنطقة الزمنية') }}</label>
                    <select class="form-select" id="user-timezone">
                        <!-- Africa -->
                        <optgroup label="{{ t('أفريقيا') }}">
                            <option value="Africa/Abidjan">{{ t('أبيدجان (Africa/Abidjan)') }}</option>
                            <option value="Africa/Accra">{{ t('أكرا (Africa/Accra)') }}</option>
                            <option value="Africa/Addis_Ababa">{{ t('أديس أبابا (Africa/Addis_Ababa)') }}</option>
                            <option value="Africa/Algiers">{{ t('الجزائر (Africa/Algiers)') }}</option>
                            <option value="Africa/Cairo">{{ t('القاهرة (Africa/Cairo)') }}</option>
                            <option value="Africa/Casablanca">{{ t('الدار البيضاء (Africa/Casablanca)') }}</option>
                            <option value="Africa/Dar_es_Salaam">{{ t('دار السلام (Africa/Dar_es_Salaam)') }}</option>
                            <option value="Africa/Djibouti">{{ t('جيبوتي (Africa/Djibouti)') }}</option>
                            <option value="Africa/Johannesburg">{{ t('جوهانسبرج (Africa/Johannesburg)') }}</option>
                            <option value="Africa/Kampala">{{ t('كمبالا (Africa/Kampala)') }}</option>
                            <option value="Africa/Khartoum">{{ t('الخرطوم (Africa/Khartoum)') }}</option>
                            <option value="Africa/Lagos">{{ t('لاغوس (Africa/Lagos)') }}</option>
                            <option value="Africa/Maputo">{{ t('مابوتو (Africa/Maputo)') }}</option>
                            <option value="Africa/Mogadishu">{{ t('مقديشو (Africa/Mogadishu)') }}</option>
                            <option value="Africa/Nairobi">{{ t('نيروبي (Africa/Nairobi)') }}</option>
                            <option value="Africa/Tripoli">{{ t('طرابلس (Africa/Tripoli)') }}</option>
                            <option value="Africa/Tunis">{{ t('تونس (Africa/Tunis)') }}</option>
                        </optgroup>

                        <!-- America - North -->
                        <optgroup label="{{ t('أمريكا الشمالية') }}">
                            <option value="America/Anchorage">{{ t('أنكوراج (America/Anchorage)') }}</option>
                            <option value="America/Chicago">{{ t('شيكاغو (America/Chicago)') }}</option>
                            <option value="America/Denver">{{ t('دنفر (America/Denver)') }}</option>
                            <option value="America/Los_Angeles">{{ t('لوس أنجلوس (America/Los_Angeles)') }}</option>
                            <option value="America/Mexico_City">{{ t('مكسيكو سيتي (America/Mexico_City)') }}</option>
                            <option value="America/New_York">{{ t('نيويورك (America/New_York)') }}</option>
                            <option value="America/Phoenix">{{ t('فينكس (America/Phoenix)') }}</option>
                            <option value="America/Toronto">{{ t('تورونتو (America/Toronto)') }}</option>
                            <option value="America/Vancouver">{{ t('فانكوفر (America/Vancouver)') }}</option>
                        </optgroup>

                        <!-- America - South -->
                        <optgroup label="{{ t('أمريكا الجنوبية') }}">
                            <option value="America/Argentina/Buenos_Aires">{{ t('بوينس آيرس
                                (America/Argentina/Buenos_Aires)') }}
                            </option>
                            <option value="America/Bogota">{{ t('بوغوتا (America/Bogota)') }}</option>
                            <option value="America/Caracas">{{ t('كاراكاس (America/Caracas)') }}</option>
                            <option value="America/Lima">{{ t('ليما (America/Lima)') }}</option>
                            <option value="America/Santiago">{{ t('سانتياغو (America/Santiago)') }}</option>
                            <option value="America/Sao_Paulo">{{ t('ساو باولو (America/Sao_Paulo)') }}</option>
                        </optgroup>

                        <!-- America - Central -->
                        <optgroup label="{{ t('أمريكا الوسطى والكاريبي') }}">
                            <option value="America/Costa_Rica">{{ t('سان خوسيه (America/Costa_Rica)') }}</option>
                            <option value="America/Havana">{{ t('هافانا (America/Havana)') }}</option>
                            <option value="America/Jamaica">{{ t('جامايكا (America/Jamaica)') }}</option>
                            <option value="America/Panama">{{ t('بنما (America/Panama)') }}</option>
                            <option value="America/Port-au-Prince">{{ t('بورت أو برنس (America/Port-au-Prince)') }}
                            </option>
                        </optgroup>

                        <!-- Asia - Middle East -->
                        <optgroup label="{{ t('الشرق الأوسط') }}">
                            <option value="Asia/Amman">{{ t('عمّان (Asia/Amman)') }}</option>
                            <option value="Asia/Baghdad">{{ t('بغداد (Asia/Baghdad)') }}</option>
                            <option value="Asia/Bahrain">{{ t('البحرين (Asia/Bahrain)') }}</option>
                            <option value="Asia/Beirut">{{ t('بيروت (Asia/Beirut)') }}</option>
                            <option value="Asia/Damascus">{{ t('دمشق (Asia/Damascus)') }}</option>
                            <option value="Asia/Dubai">{{ t('دبي (Asia/Dubai)') }}</option>
                            <option value="Asia/Gaza">{{ t('غزة (Asia/Gaza)') }}</option>
                            <option value="Asia/Jerusalem">{{ t('القدس (Asia/Jerusalem)') }}</option>
                            <option value="Asia/Kuwait">{{ t('الكويت (Asia/Kuwait)') }}</option>
                            <option value="Asia/Muscat">{{ t('مسقط (Asia/Muscat)') }}</option>
                            <option value="Asia/Qatar">{{ t('قطر (Asia/Qatar)') }}</option>
                            <option value="Asia/Riyadh">{{ t('الرياض (Asia/Riyadh)') }}</option>
                            <option value="Asia/Tehran">{{ t('طهران (Asia/Tehran)') }}</option>
                        </optgroup>

                        <!-- Asia - Central & South -->
                        <optgroup label="{{ t('آسيا الوسطى والجنوبية') }}">
                            <option value="Asia/Kabul">{{ t('كابول (Asia/Kabul)') }}</option>
                            <option value="Asia/Karachi">{{ t('كراتشي (Asia/Karachi)') }}</option>
                            <option value="Asia/Kolkata">{{ t('كولكاتا (Asia/Kolkata)') }}</option>
                            <option value="Asia/Colombo">{{ t('كولومبو (Asia/Colombo)') }}</option>
                            <option value="Asia/Dhaka">{{ t('دكا (Asia/Dhaka)') }}</option>
                            <option value="Asia/Kathmandu">{{ t('كاتماندو (Asia/Kathmandu)') }}</option>
                            <option value="Asia/Tashkent">{{ t('طشقند (Asia/Tashkent)') }}</option>
                        </optgroup>

                        <!-- Asia - East & Southeast -->
                        <optgroup label="{{ t('شرق وجنوب شرق آسيا') }}">
                            <option value="Asia/Bangkok">{{ t('بانكوك (Asia/Bangkok)') }}</option>
                            <option value="Asia/Hong_Kong">{{ t('هونغ كونغ (Asia/Hong_Kong)') }}</option>
                            <option value="Asia/Jakarta">{{ t('جاكرتا (Asia/Jakarta)') }}</option>
                            <option value="Asia/Kuala_Lumpur">{{ t('كوالالمبور (Asia/Kuala_Lumpur)') }}</option>
                            <option value="Asia/Manila">{{ t('مانيلا (Asia/Manila)') }}</option>
                            <option value="Asia/Seoul">{{ t('سيول (Asia/Seoul)') }}</option>
                            <option value="Asia/Shanghai">{{ t('شنغهاي (Asia/Shanghai)') }}</option>
                            <option value="Asia/Singapore">{{ t('سنغافورة (Asia/Singapore)') }}</option>
                            <option value="Asia/Taipei">{{ t('تايبيه (Asia/Taipei)') }}</option>
                            <option value="Asia/Tokyo">{{ t('طوكيو (Asia/Tokyo)') }}</option>
                            <option value="Asia/Yangon">{{ t('يانغون (Asia/Yangon)') }}</option>
                        </optgroup>

                        <!-- Europe - Western -->
                        <optgroup label="{{ t('أوروبا الغربية') }}">
                            <option value="Europe/Dublin">{{ t('دبلن (Europe/Dublin)') }}</option>
                            <option value="Europe/Lisbon">{{ t('لشبونة (Europe/Lisbon)') }}</option>
                            <option value="Europe/London">{{ t('لندن (Europe/London)') }}</option>
                        </optgroup>

                        <!-- Europe - Central -->
                        <optgroup label="{{ t('أوروبا الوسطى') }}">
                            <option value="Europe/Amsterdam">{{ t('أمستردام (Europe/Amsterdam)') }}</option>
                            <option value="Europe/Berlin">{{ t('برلين (Europe/Berlin)') }}</option>
                            <option value="Europe/Brussels">{{ t('بروكسل (Europe/Brussels)') }}</option>
                            <option value="Europe/Madrid">{{ t('مدريد (Europe/Madrid)') }}</option>
                            <option value="Europe/Paris">{{ t('باريس (Europe/Paris)') }}</option>
                            <option value="Europe/Rome">{{ t('روما (Europe/Rome)') }}</option>
                            <option value="Europe/Vienna">{{ t('فيينا (Europe/Vienna)') }}</option>
                            <option value="Europe/Zurich">{{ t('زيورخ (Europe/Zurich)') }}</option>
                        </optgroup>

                        <!-- Europe - Eastern -->
                        <optgroup label="{{ t('أوروبا الشرقية') }}">
                            <option value="Europe/Athens">{{ t('أثينا (Europe/Athens)') }}</option>
                            <option value="Europe/Bucharest">{{ t('بوخارست (Europe/Bucharest)') }}</option>
                            <option value="Europe/Helsinki">{{ t('هلسنكي (Europe/Helsinki)') }}</option>
                            <option value="Europe/Istanbul">{{ t('إسطنبول (Europe/Istanbul)') }}</option>
                            <option value="Europe/Kiev">{{ t('كييف (Europe/Kiev)') }}</option>
                            <option value="Europe/Moscow">{{ t('موسكو (Europe/Moscow)') }}</option>
                            <option value="Europe/Warsaw">{{ t('وارسو (Europe/Warsaw)') }}</option>
                        </optgroup>

                        <!-- Australia & Pacific -->
                        <optgroup label="{{ t('أستراليا والمحيط الهادئ') }}">
                            <option value="Australia/Adelaide">{{ t('أديليد (Australia/Adelaide)') }}</option>
                            <option value="Australia/Brisbane">{{ t('بريسبان (Australia/Brisbane)') }}</option>
                            <option value="Australia/Darwin">{{ t('داروين (Australia/Darwin)') }}</option>
                            <option value="Australia/Melbourne">{{ t('ملبورن (Australia/Melbourne)') }}</option>
                            <option value="Australia/Perth">{{ t('بيرث (Australia/Perth)') }}</option>
                            <option value="Australia/Sydney">{{ t('سيدني (Australia/Sydney)') }}</option>
                            <option value="Pacific/Auckland">{{ t('أوكلاند (Pacific/Auckland)') }}</option>
                            <option value="Pacific/Fiji">{{ t('فيجي (Pacific/Fiji)') }}</option>
                            <option value="Pacific/Guam">{{ t('غوام (Pacific/Guam)') }}</option>
                            <option value="Pacific/Honolulu">{{ t('هونولولو (Pacific/Honolulu)') }}</option>
                        </optgroup>

                        <!-- Atlantic -->
                        <optgroup label="{{ t('المحيط الأطلسي') }}">
                            <option value="Atlantic/Azores">{{ t('الأزور (Atlantic/Azores)') }}</option>
                            <option value="Atlantic/Cape_Verde">{{ t('الرأس الأخضر (Atlantic/Cape_Verde)') }}</option>
                            <option value="Atlantic/Reykjavik">{{ t('ريكيافيك (Atlantic/Reykjavik)') }}</option>
                        </optgroup>

                        <!-- Indian Ocean -->
                        <optgroup label="{{ t('المحيط الهندي') }}">
                            <option value="Indian/Mauritius">{{ t('موريشيوس (Indian/Mauritius)') }}</option>
                            <option value="Indian/Maldives">{{ t('المالديف (Indian/Maldives)') }}</option>
                        </optgroup>

                        <!-- UTC -->
                        <optgroup label="{{ t('التوقيت العالمي المنسق') }}">
                            <option value="UTC">{{ t('UTC') }}</option>
                        </optgroup>
                    </select>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-bell me-2"></i>
                    {{ t('الإشعارات') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-check">
                        <input class="form-check-input" type="checkbox" id="notify-browser">
                        <span class="form-check-label">{{ t('إشعارات المتصفح') }}</span>
                    </label>
                    <small class="form-hint">{{ t('إشعارات فورية في المتصفح') }}</small>
                </div>
                <div class="alert alert-info">
                    <i class="ti ti-info-circle me-2"></i>
                    {{ t('إشعارات التليجرام والبريد الإلكتروني يتم تحديدها لكل مساعد على حدة من صفحة المساعدين') }}
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary" onclick="savePreferences()">{{ t('حفظ التفضيلات') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Account Info -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-info-circle me-2"></i>
                    {{ t('معلومات الحساب') }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ t('تاريخ التسجيل') }}</label>
                            <div id="account-created"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ t('آخر تسجيل دخول') }}</label>
                            <div id="account-last-login"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ t('رقم المستخدم') }}</label>
                            <div id="account-id"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Change Phone Modal -->
<div class="modal fade" id="modal-change-phone" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('تغيير رقم الهاتف') }}</h5>
                <button type="button" class="btn-close" onclick="hideModal('modal-change-phone')"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('رقم الهاتف الجديد') }}</label>
                    <input type="tel" class="form-control" id="new-phone" placeholder="01234567890">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('modal-change-phone')">{{ t('إلغاء') }}</button>
                <button type="button" class="btn btn-primary" onclick="changePhone()">{{ t('تغيير') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Telegram Modal -->
<div class="modal fade" id="modal-change-telegram" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('تغيير معرف التليجرام') }}</h5>
                <button type="button" class="btn-close" onclick="hideModal('modal-change-telegram')"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('معرف التليجرام الجديد') }}</label>
                    <input type="text" class="form-control" id="new-telegram" placeholder="123456789">
                    <small class="form-hint">{{ t('يمكنك الحصول على معرفك من') }} @NonRealAssistantBot</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('modal-change-telegram')">{{ t('إلغاء') }}</button>
                <button type="button" class="btn btn-primary" onclick="changeTelegram()">{{ t('تغيير') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    let userData = {};
    let languagesMap = {};

    document.addEventListener('DOMContentLoaded', function () {
        loadLanguages();
        loadUserProfile();
    });

    async function loadLanguages() {
        try {
            const response = await fetch('/api/languages');
            const languages = await response.json();
            languages.forEach(lang => {
                languagesMap[lang.iso_code] = lang.id;
            });
        } catch (error) {
            console.error('Error loading languages:', error);
        }
    }

    function loadUserProfile() {
        fetch('/api/user/profile')
            .then(r => r.json())
            .then(data => {
                userData = data;
                document.getElementById('user-name').value = data.name || '';
                document.getElementById('user-email').value = data.email || '';
                document.getElementById('user-phone').value = data.mobile || '';
                document.getElementById('user-telegram').value = data.telegram_id || '';

                // Handle language - can be object or id
                if (data.language && data.language.iso_code) {
                    document.getElementById('user-language').value = data.language.iso_code;
                } else {
                    document.getElementById('user-language').value = 'en';
                }

                document.getElementById('user-timezone').value = data.timezone || 'Africa/Cairo';
                document.getElementById('notify-browser').checked = data.browser_notify;

                document.getElementById('account-id').textContent = '#' + data.id;
                document.getElementById('account-created').textContent = data.create_time ? new Date(data.create_time).toLocaleDateString('ar') : '-';
                document.getElementById('account-last-login').textContent = '-';

                // Update avatar display
                updateAvatarDisplay(data.avatar, data.name, data.mobile);
            });
    }

    function updateAvatarDisplay(avatar, name, mobile) {
        const container = document.getElementById('avatar-container');
        if (!container) return;

        if (avatar) {
            container.innerHTML = `<span class="avatar avatar-xl" id="avatar-preview" style="width: 100px; height: 100px; background-image: url('/uploads/avatars/${avatar}?t=${Date.now()}'); cursor: pointer;" onclick="document.getElementById('avatar-input').click()"></span>`;
        } else {
            const initials = name ? name.charAt(0).toUpperCase() : (mobile ? mobile.slice(-2) : '');
            container.innerHTML = `<span class="avatar avatar-xl bg-primary-lt" id="avatar-preview" style="width: 100px; height: 100px; font-size: 36px; cursor: pointer;" onclick="document.getElementById('avatar-input').click()">${initials}</span>`;
        }
    }

    async function uploadAvatar(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Validate file size (2MB max)
        if (file.size > 2 * 1024 * 1024) {
            showToast("{{ t('حجم الصورة يجب أن لا يتجاوز 2MB') }}", 'warning');
            return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showToast("{{ t('يرجى اختيار صورة صالحة') }}", 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', file);

        try {
            const response = await fetch('/api/user/avatar', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showToast("{{ t('تم تحديث الصورة بنجاح') }}", 'success');
                updateAvatarDisplay(data.avatar, userData.name, userData.mobile);
                // Reload to update navbar
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || "{{ t('فشل رفع الصورة') }}", 'danger');
            }
        } catch (error) {
            console.error('Error uploading avatar:', error);
            showToast("{{ t('حدث خطأ في رفع الصورة') }}", 'danger');
        }

        // Clear input
        input.value = '';
    }

    function saveProfile() {
        const data = {
            name: document.getElementById('user-name').value,
            email: document.getElementById('user-email').value
        };

        fetch('/api/user/profile', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast("{{ t('تم حفظ الملف الشخصي بنجاح') }}", 'success');
                } else {
                    showToast("{{ t('خطأ:') }} " + (data.error || "{{ t('فشل الحفظ') }}"), 'danger');
                }
            });
    }

    function savePreferences() {
        const languageCode = document.getElementById('user-language').value;
        const languageId = languagesMap[languageCode];

        if (!languageId) {
            showToast("{{ t('خطأ في تحديد اللغة') }}", 'danger');
            return;
        }

        const data = {
            language_id: languageId,
            timezone: document.getElementById('user-timezone').value,
            browser_notify: document.getElementById('notify-browser').checked
        };

        fetch('/api/user/profile', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    showToast("{{ t('تم حفظ التفضيلات بنجاح') }}", 'success');
                    // Check if language changed
                    const oldLang = userData.language ? userData.language.iso_code : 'en';
                    if (languageCode !== oldLang) {
                        setTimeout(() => location.reload(), 500);
                    }
                } else {
                    showToast("{{ t('خطأ:') }} " + (response.error || "{{ t('فشل الحفظ') }}"), 'danger');
                }
            });
    }

    function changePhone() {
        const phone = document.getElementById('new-phone').value.trim();
        if (!phone) {
            showToast("{{ t('يرجى إدخال رقم الهاتف') }}", 'warning');
            return;
        }

        fetch('/api/user/phone', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone})
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideModal('modal-change-phone');
                    loadUserProfile();
                    showToast("{{ t('تم تغيير رقم الهاتف بنجاح') }}", 'success');
                } else {
                    showToast("{{ t('خطأ:') }} " + (data.error || "{{ t('فشل التغيير') }}"), 'danger');
                }
            });
    }

    function changeTelegram() {
        const telegram_id = document.getElementById('new-telegram').value.trim();
        if (!telegram_id) {
            showToast("{{ t('يرجى إدخال معرف التليجرام') }}", 'warning');
            return;
        }

        fetch('/api/user/telegram', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_id})
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideModal('modal-change-telegram');
                    loadUserProfile();
                    showToast("{{ t('تم تغيير معرف التليجرام بنجاح') }}", 'success');
                } else {
                    showToast("{{ t('خطأ:') }} " + (data.error || "{{ t('فشل التغيير') }}"), 'danger');
                }
            });
    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('show');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');

        // Add backdrop
        let backdrop = document.querySelector('.modal-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
    }

    function showChangePhone() {
        document.getElementById('new-phone').value = '';
        showModal('modal-change-phone');
    }

    function showChangeTelegram() {
        document.getElementById('new-telegram').value = '';
        showModal('modal-change-telegram');
    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('show');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');

        // Add backdrop
        let backdrop = document.querySelector('.modal-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');

        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
    }

    function changePhone() {
        const phone = document.getElementById('new-phone').value.trim();
        if (!phone) {
            showToast("{{ t('يرجى إدخال رقم الهاتف') }}", 'warning');
            return;
        }

        fetch('/api/user/phone', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone})
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideModal('modal-change-phone');
                    loadUserProfile();
                    showToast("{{ t('تم تغيير رقم الهاتف بنجاح') }}", 'success');
                } else {
                    showToast("{{ t('خطأ:') }} " + (data.error || "{{ t('فشل التغيير') }}"), 'danger');
                }
            });
    }

    function changeTelegram() {
        const telegram_id = document.getElementById('new-telegram').value.trim();
        if (!telegram_id) {
            showToast("{{ t('يرجى إدخال معرف التليجرام') }}", 'warning');
            return;
        }

        fetch('/api/user/telegram', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_id})
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideModal('modal-change-telegram');
                    loadUserProfile();
                    showToast("{{ t('تم تغيير معرف التليجرام بنجاح') }}", 'success');
                } else {
                    showToast("{{ t('خطأ:') }} " + (data.error || "{{ t('فشل التغيير') }}"), 'danger');
                }
            });
    }

    function showToast(message, type = 'success') {
        const bgColors = {
            'success': 'bg-green',
            'danger': 'bg-red',
            'warning': 'bg-yellow',
            'info': 'bg-blue'
        };

        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 start-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white ${bgColors[type] || 'bg-green'} border-0`;
        toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    // Close modal on backdrop click
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal')) {
            hideModal(e.target.id);
        }
    });
</script>
{% endblock %}
