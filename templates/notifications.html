{% extends "base.html" %}

{% block title %}سجل الإشعارات - Non Real Assistant{% endblock %}

{% block page_title %}سجل الإشعارات{% endblock %}
{% block page_subtitle %}عرض جميع الإشعارات المرسلة{% endblock %}

{% block page_css %}
<style>
    .message-preview {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <select class="form-select" id="channel-filter" onchange="loadNotifications()" style="width: auto;">
        <option value="">جميع القنوات</option>
        <option value="telegram">تيليجرام</option>
        <option value="email">بريد إلكتروني</option>
        <option value="browser">المتصفح</option>
    </select>
    <select class="form-select" id="status-filter" onchange="loadNotifications()" style="width: auto;">
        <option value="">جميع الحالات</option>
        <option value="sent">تم الإرسال</option>
        <option value="failed">فشل</option>
    </select>
</div>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="row row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-blue text-white avatar">
                            <i class="ti ti-bell"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-total">0</div>
                        <div class="text-muted">إجمالي الإشعارات</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-green text-white avatar">
                            <i class="ti ti-check"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-sent">0</div>
                        <div class="text-muted">تم الإرسال</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-red text-white avatar">
                            <i class="ti ti-x"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-failed">0</div>
                        <div class="text-muted">فشل</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-cyan text-white avatar">
                            <i class="ti ti-brand-telegram"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-telegram">0</div>
                        <div class="text-muted">تيليجرام</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-vcenter card-table">
            <thead>
                <tr>
                    <th>القناة</th>
                    <th>الحالة</th>
                    <th>المهمة / المساعد</th>
                    <th>الرسالة</th>
                    <th>التاريخ</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="notifications-tbody">
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-muted" role="status"></div>
                        <div class="mt-2">جاري التحميل...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Notification Details Modal -->
<div class="modal modal-blur fade" id="modal-notification" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل الإشعار</h5>
                <button type="button" class="btn-close" onclick="hideModal('modal-notification')"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('modal-notification')">إغلاق</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let allNotifications = [];

document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    loadStats();
});

async function loadNotifications() {
    const tbody = document.getElementById('notifications-tbody');
    const channelFilter = document.getElementById('channel-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    try {
        let url = '/api/notification-logs?limit=100';
        if (channelFilter) url += `&channel=${channelFilter}`;
        if (statusFilter) url += `&status=${statusFilter}`;

        const response = await fetch(url);
        allNotifications = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load notifications');
        }

        displayNotifications(allNotifications);

    } catch (error) {
        console.error('Error loading notifications:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="ti ti-alert-circle icon text-red mb-2" style="font-size: 2rem;"></i>
                    <div class="text-muted">حدث خطأ في تحميل الإشعارات</div>
                </td>
            </tr>
        `;
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/notification-logs/stats');
        const stats = await response.json();

        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-sent').textContent = stats.sent || 0;
        document.getElementById('stat-failed').textContent = stats.failed || 0;
        document.getElementById('stat-telegram').textContent = stats.by_channel?.telegram || 0;

    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function displayNotifications(notifications) {
    const tbody = document.getElementById('notifications-tbody');

    if (notifications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="ti ti-bell-off icon text-muted mb-2" style="font-size: 2rem;"></i>
                    <div class="text-muted">لا توجد إشعارات</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = notifications.map(notification => createNotificationRow(notification)).join('');
}

function createNotificationRow(notification) {
    const statusClass = notification.status === 'sent' ? 'green' : 'red';
    const statusText = notification.status === 'sent' ? 'تم الإرسال' : 'فشل';
    const channelIcon = getChannelIcon(notification.channel);
    const channelName = getChannelName(notification.channel);
    const messagePreview = notification.message ? notification.message.substring(0, 50) + (notification.message.length > 50 ? '...' : '') : '-';

    return `
        <tr>
            <td>
                <span class="avatar avatar-sm bg-${getChannelColor(notification.channel)}-lt">
                    <i class="ti ${channelIcon}"></i>
                </span>
                <span class="ms-2">${channelName}</span>
            </td>
            <td>
                <span class="badge bg-${statusClass}-lt text-${statusClass}">${statusText}</span>
            </td>
            <td>
                ${notification.task_name ? `<div><i class="ti ti-list-check me-1"></i>${escapeHtml(notification.task_name)}</div>` : ''}
                ${notification.assistant_name ? `<div class="text-muted small"><i class="ti ti-robot me-1"></i>${escapeHtml(notification.assistant_name)}</div>` : ''}
                ${!notification.task_name && !notification.assistant_name ? '<span class="text-muted">-</span>' : ''}
            </td>
            <td>
                <div class="message-preview text-muted">${escapeHtml(messagePreview)}</div>
            </td>
            <td class="text-muted">
                ${formatDateTime(notification.create_time)}
            </td>
            <td>
                <button class="btn btn-ghost-primary btn-sm" onclick="viewNotification(${notification.id})" title="عرض التفاصيل">
                    <i class="ti ti-eye"></i>
                </button>
            </td>
        </tr>
    `;
}

function getChannelIcon(channel) {
    const icons = {
        'telegram': 'ti-brand-telegram',
        'email': 'ti-mail',
        'browser': 'ti-browser'
    };
    return icons[channel] || 'ti-bell';
}

function getChannelName(channel) {
    const names = {
        'telegram': 'تيليجرام',
        'email': 'بريد',
        'browser': 'متصفح'
    };
    return names[channel] || channel;
}

function getChannelColor(channel) {
    const colors = {
        'telegram': 'cyan',
        'email': 'blue',
        'browser': 'yellow'
    };
    return colors[channel] || 'gray';
}

function viewNotification(notificationId) {
    const notification = allNotifications.find(n => n.id === notificationId);
    if (!notification) return;

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label text-muted">القناة</label>
                <div><i class="ti ${getChannelIcon(notification.channel)} me-2"></i>${getChannelName(notification.channel)}</div>
            </div>
            <div class="col-md-6">
                <label class="form-label text-muted">الحالة</label>
                <div>
                    <span class="badge bg-${notification.status === 'sent' ? 'green' : 'red'}-lt">
                        ${notification.status === 'sent' ? 'تم الإرسال' : 'فشل'}
                    </span>
                </div>
            </div>
        </div>
        ${notification.task_name ? `
            <div class="mb-3">
                <label class="form-label text-muted">المهمة</label>
                <div>${escapeHtml(notification.task_name)}</div>
            </div>
        ` : ''}
        ${notification.assistant_name ? `
            <div class="mb-3">
                <label class="form-label text-muted">المساعد</label>
                <div>${escapeHtml(notification.assistant_name)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label text-muted">الرسالة</label>
            <div class="card">
                <div class="card-body" style="white-space: pre-wrap; direction: rtl;">${notification.message ? escapeHtml(notification.message) : 'لا توجد رسالة'}</div>
            </div>
        </div>
        ${notification.error_message ? `
            <div class="mb-3">
                <label class="form-label text-muted">رسالة الخطأ</label>
                <div class="alert alert-danger">${escapeHtml(notification.error_message)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label text-muted">التاريخ</label>
            <div>${formatDateTime(notification.create_time)}</div>
        </div>
    `;

    showModal('modal-notification');
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    modal.style.display = 'block';
    document.body.classList.add('modal-open');

    let backdrop = document.querySelector('.modal-backdrop');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');

    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'Z');
    if (isNaN(date.getTime())) return '';

    const now = new Date();
    const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diff < 60) return 'الآن';
    if (diff < 3600) return `منذ ${Math.floor(diff / 60)} دقيقة`;
    if (diff < 86400) return `منذ ${Math.floor(diff / 3600)} ساعة`;

    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Close modal on backdrop click
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        hideModal(e.target.id);
    }
});
</script>
{% endblock %}
