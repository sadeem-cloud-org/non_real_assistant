{% extends "base.html" %}

{% block title %}{{ t('سجل الإشعارات') }} - Non Real Assistant{% endblock %}

{% block page_title %}{{ t('سجل الإشعارات') }}{% endblock %}
{% block page_subtitle %}{{ t('عرض جميع الإشعارات المرسلة') }}{% endblock %}

{% block page_css %}
<style>
    .message-preview {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <select class="form-select" id="channel-filter" onchange="loadNotifications()" style="width: auto;">
        <option value="">{{ t('جميع القنوات') }}</option>
        <option value="telegram">{{ t('تيليجرام') }}</option>
        <option value="email">{{ t('بريد إلكتروني') }}</option>
        <option value="browser">{{ t('المتصفح') }}</option>
    </select>
    <select class="form-select" id="status-filter" onchange="loadNotifications()" style="width: auto;">
        <option value="">{{ t('جميع الحالات') }}</option>
        <option value="sent">{{ t('تم الإرسال') }}</option>
        <option value="failed">{{ t('فشل') }}</option>
    </select>
</div>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="row row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-blue text-white avatar">
                            <i class="ti ti-bell"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-total">0</div>
                        <div class="text-muted">{{ t('إجمالي الإشعارات') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-green text-white avatar">
                            <i class="ti ti-check"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-sent">0</div>
                        <div class="text-muted">{{ t('تم الإرسال') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-red text-white avatar">
                            <i class="ti ti-x"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-failed">0</div>
                        <div class="text-muted">{{ t('فشل') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-cyan text-white avatar">
                            <i class="ti ti-brand-telegram"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-telegram">0</div>
                        <div class="text-muted">{{ t('تيليجرام') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-vcenter card-table">
            <thead>
                <tr>
                    <th>{{ t('القناة') }}</th>
                    <th>{{ t('الحالة') }}</th>
                    <th>{{ t('المهمة / المساعد') }}</th>
                    <th>{{ t('الرسالة') }}</th>
                    <th>{{ t('التاريخ') }}</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="notifications-tbody">
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-muted" role="status"></div>
                        <div class="mt-2">{{ t('جاري التحميل...') }}</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Notification Details Modal -->
<div class="modal modal-blur fade" id="modal-notification" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('تفاصيل الإشعار') }}</h5>
                <button type="button" class="btn-close" onclick="hideModal('modal-notification')"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('modal-notification')">{{ t('إغلاق') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
// Translation strings
const translations = {
    'sent': "{{ t('تم الإرسال') }}",
    'failed': "{{ t('فشل') }}",
    'telegram': "{{ t('تيليجرام') }}",
    'email': "{{ t('بريد') }}",
    'browser': "{{ t('متصفح') }}",
    'task': "{{ t('المهمة') }}",
    'assistant': "{{ t('المساعد') }}",
    'message': "{{ t('الرسالة') }}",
    'no_message': "{{ t('لا توجد رسالة') }}",
    'error_message': "{{ t('رسالة الخطأ') }}",
    'date': "{{ t('التاريخ') }}",
    'channel': "{{ t('القناة') }}",
    'status': "{{ t('الحالة') }}",
    'view_details': "{{ t('عرض التفاصيل') }}",
    'no_notifications': "{{ t('لا توجد إشعارات') }}",
    'error_loading': "{{ t('حدث خطأ في تحميل الإشعارات') }}",
    'now': "{{ t('الآن') }}",
    'minutes_ago': "{{ t('منذ') }}",
    'minute': "{{ t('دقيقة') }}",
    'minutes_two': "{{ t('دقيقتين') }}",
    'hours_ago': "{{ t('منذ') }}",
    'hour': "{{ t('ساعة') }}",
    'hours_two': "{{ t('ساعتين') }}"
};

let allNotifications = [];

document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    loadStats();
});

async function loadNotifications() {
    const tbody = document.getElementById('notifications-tbody');
    const channelFilter = document.getElementById('channel-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    try {
        let url = '/api/notification-logs?limit=100';
        if (channelFilter) url += `&channel=${channelFilter}`;
        if (statusFilter) url += `&status=${statusFilter}`;

        const response = await fetch(url);
        allNotifications = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load notifications');
        }

        displayNotifications(allNotifications);

    } catch (error) {
        console.error('Error loading notifications:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="ti ti-alert-circle icon text-red mb-2" style="font-size: 2rem;"></i>
                    <div class="text-muted">${translations.error_loading}</div>
                </td>
            </tr>
        `;
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/notification-logs/stats');
        const stats = await response.json();

        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-sent').textContent = stats.sent || 0;
        document.getElementById('stat-failed').textContent = stats.failed || 0;
        document.getElementById('stat-telegram').textContent = stats.by_channel?.telegram || 0;

    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function displayNotifications(notifications) {
    const tbody = document.getElementById('notifications-tbody');

    if (notifications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="ti ti-bell-off icon text-muted mb-2" style="font-size: 2rem;"></i>
                    <div class="text-muted">${translations.no_notifications}</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = notifications.map(notification => createNotificationRow(notification)).join('');
}

function createNotificationRow(notification) {
    const statusClass = notification.status === 'sent' ? 'green' : 'red';
    const statusText = translations[notification.status] || notification.status;
    const channelIcon = getChannelIcon(notification.channel);
    const channelName = translations[notification.channel] || notification.channel;
    const messagePreview = notification.message ? notification.message.substring(0, 50) + (notification.message.length > 50 ? '...' : '') : '-';

    return `
        <tr>
            <td>
                <span class="avatar avatar-sm bg-${getChannelColor(notification.channel)}-lt">
                    <i class="ti ${channelIcon}"></i>
                </span>
                <span class="ms-2">${channelName}</span>
            </td>
            <td>
                <span class="badge bg-${statusClass}-lt text-${statusClass}">${statusText}</span>
            </td>
            <td>
                ${notification.task_name ? `<div><i class="ti ti-list-check me-1"></i>${escapeHtml(notification.task_name)}</div>` : ''}
                ${notification.assistant_name ? `<div class="text-muted small"><i class="ti ti-robot me-1"></i>${escapeHtml(notification.assistant_name)}</div>` : ''}
                ${!notification.task_name && !notification.assistant_name ? '<span class="text-muted">-</span>' : ''}
            </td>
            <td>
                <div class="message-preview text-muted">${escapeHtml(messagePreview)}</div>
            </td>
            <td class="text-muted">
                ${formatDateTime(notification.create_time)}
            </td>
            <td>
                <button class="btn btn-ghost-primary btn-sm" onclick="viewNotification(${notification.id})" title="${translations.view_details}">
                    <i class="ti ti-eye"></i>
                </button>
            </td>
        </tr>
    `;
}

function getChannelIcon(channel) {
    const icons = {
        'telegram': 'ti-brand-telegram',
        'email': 'ti-mail',
        'browser': 'ti-browser'
    };
    return icons[channel] || 'ti-bell';
}

function getChannelColor(channel) {
    const colors = {
        'telegram': 'cyan',
        'email': 'blue',
        'browser': 'yellow'
    };
    return colors[channel] || 'gray';
}

function viewNotification(notificationId) {
    const notification = allNotifications.find(n => n.id === notificationId);
    if (!notification) return;

    const channelName = translations[notification.channel] || notification.channel;
    const statusText = translations[notification.status] || notification.status;

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label text-muted">${translations.channel}</label>
                <div><i class="ti ${getChannelIcon(notification.channel)} me-2"></i>${channelName}</div>
            </div>
            <div class="col-md-6">
                <label class="form-label text-muted">${translations.status}</label>
                <div>
                    <span class="badge bg-${notification.status === 'sent' ? 'green' : 'red'}-lt">
                        ${statusText}
                    </span>
                </div>
            </div>
        </div>
        ${notification.task_name ? `
            <div class="mb-3">
                <label class="form-label text-muted">${translations.task}</label>
                <div>${escapeHtml(notification.task_name)}</div>
            </div>
        ` : ''}
        ${notification.assistant_name ? `
            <div class="mb-3">
                <label class="form-label text-muted">${translations.assistant}</label>
                <div>${escapeHtml(notification.assistant_name)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label text-muted">${translations.message}</label>
            <div class="card">
                <div class="card-body" style="white-space: pre-wrap; direction: rtl;">${notification.message ? escapeHtml(notification.message) : translations.no_message}</div>
            </div>
        </div>
        ${notification.error_message ? `
            <div class="mb-3">
                <label class="form-label text-muted">${translations.error_message}</label>
                <div class="alert alert-danger">${escapeHtml(notification.error_message)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label text-muted">${translations.date}</label>
            <div>${formatDateTime(notification.create_time)}</div>
        </div>
    `;

    showModal('modal-notification');
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    modal.style.display = 'block';
    document.body.classList.add('modal-open');

    let backdrop = document.querySelector('.modal-backdrop');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');

    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'Z');
    if (isNaN(date.getTime())) return '';

    const now = new Date();
    const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diff < 60) return translations.now;
    if (diff < 120) return translations.minutes_ago + ' ' + translations.minute;
    if (diff < 180) return translations.minutes_ago + ' ' + translations.minutes_two;
    if (diff < 3600) return translations.minutes_ago + ' ' + Math.floor(diff / 60) + ' ' + translations.minute;
    if (diff < 7200) return translations.hours_ago + ' ' + translations.hour;
    if (diff < 10800) return translations.hours_ago + ' ' + translations.hours_two;
    if (diff < 86400) return translations.hours_ago + ' ' + Math.floor(diff / 3600) + ' ' + translations.hour;

    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Close modal on backdrop click
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        hideModal(e.target.id);
    }
});
</script>
{% endblock %}