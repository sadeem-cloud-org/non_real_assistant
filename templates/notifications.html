{% extends "base.html" %}

{% block title %}سجل الإشعارات - Non Real Assistant{% endblock %}

{% block page_title %}سجل الإشعارات{% endblock %}
{% block page_subtitle %}عرض جميع الإشعارات المرسلة{% endblock %}

{% block page_css %}
<style>
    .notification-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .notification-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .message-box {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
    }
    [data-bs-theme="dark"] .message-box {
        background: #1e1e1e;
        border-color: #444;
    }
</style>
{% endblock %}

{% block page_actions %}
<select class="form-select" id="channel-filter" onchange="loadNotifications()" style="width: auto; display: inline-block;">
    <option value="">جميع القنوات</option>
    <option value="telegram">تيليجرام</option>
    <option value="email">بريد إلكتروني</option>
    <option value="browser">المتصفح</option>
</select>
<select class="form-select ms-2" id="status-filter" onchange="loadNotifications()" style="width: auto; display: inline-block;">
    <option value="">جميع الحالات</option>
    <option value="sent">تم الإرسال</option>
    <option value="failed">فشل</option>
</select>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="row row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-blue text-white avatar">
                            <i class="ti ti-bell"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-total">0</div>
                        <div class="text-muted">إجمالي الإشعارات</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-green text-white avatar">
                            <i class="ti ti-check"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-sent">0</div>
                        <div class="text-muted">تم الإرسال</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-red text-white avatar">
                            <i class="ti ti-x"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-failed">0</div>
                        <div class="text-muted">فشل</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-cyan text-white avatar">
                            <i class="ti ti-brand-telegram"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium" id="stat-telegram">0</div>
                        <div class="text-muted">تيليجرام</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications List -->
<div class="row row-cards" id="notifications-container">
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-muted" role="status"></div>
        <div class="mt-2">جاري التحميل...</div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Notification Details Modal -->
<div class="modal modal-blur fade" id="modal-notification" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل الإشعار</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
let allNotifications = [];

document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    loadStats();
});

async function loadNotifications() {
    const container = document.getElementById('notifications-container');
    const channelFilter = document.getElementById('channel-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    try {
        let url = '/api/notification-logs?limit=100';
        if (channelFilter) url += `&channel=${channelFilter}`;
        if (statusFilter) url += `&status=${statusFilter}`;

        const response = await fetch(url);
        allNotifications = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load notifications');
        }

        displayNotifications(allNotifications);

    } catch (error) {
        console.error('Error loading notifications:', error);
        container.innerHTML = `
            <div class="col-12">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-alert-circle icon text-red"></i>
                    </div>
                    <p class="empty-title">حدث خطأ في تحميل الإشعارات</p>
                </div>
            </div>
        `;
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/notification-logs/stats');
        const stats = await response.json();

        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-sent').textContent = stats.sent || 0;
        document.getElementById('stat-failed').textContent = stats.failed || 0;
        document.getElementById('stat-telegram').textContent = stats.by_channel?.telegram || 0;

    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function displayNotifications(notifications) {
    const container = document.getElementById('notifications-container');

    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-bell-off icon"></i>
                    </div>
                    <p class="empty-title">لا توجد إشعارات</p>
                    <p class="empty-subtitle text-muted">لم يتم إرسال أي إشعارات بعد</p>
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = notifications.map(notification => createNotificationCard(notification)).join('');
}

function createNotificationCard(notification) {
    const statusClass = notification.status === 'sent' ? 'green' : 'red';
    const statusText = notification.status === 'sent' ? 'تم الإرسال' : 'فشل';
    const channelIcon = getChannelIcon(notification.channel);
    const channelName = getChannelName(notification.channel);

    return `
        <div class="col-md-6 col-lg-4">
            <div class="card notification-card">
                <div class="card-status-top bg-${statusClass}"></div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="avatar bg-${statusClass}-lt text-${statusClass} me-3">
                            <i class="ti ${channelIcon}"></i>
                        </span>
                        <div class="flex-fill">
                            <div class="font-weight-medium">${channelName}</div>
                            <div class="text-muted small">${statusText}</div>
                        </div>
                    </div>

                    ${notification.task_name ? `
                        <div class="mb-2">
                            <span class="badge bg-blue-lt">
                                <i class="ti ti-list-check"></i>
                                ${escapeHtml(notification.task_name)}
                            </span>
                        </div>
                    ` : ''}

                    ${notification.assistant_name ? `
                        <div class="mb-2">
                            <span class="badge bg-cyan-lt">
                                <i class="ti ti-robot"></i>
                                ${escapeHtml(notification.assistant_name)}
                            </span>
                        </div>
                    ` : ''}

                    ${notification.message ? `
                        <div class="message-box mb-3">
                            ${escapeHtml(notification.message.substring(0, 200))}${notification.message.length > 200 ? '...' : ''}
                        </div>
                    ` : ''}

                    ${notification.error_message ? `
                        <div class="alert alert-danger mb-3">
                            <i class="ti ti-alert-circle"></i>
                            ${escapeHtml(notification.error_message)}
                        </div>
                    ` : ''}

                    <div class="text-muted small">
                        <i class="ti ti-clock icon"></i>
                        ${formatDateTime(notification.create_time)}
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm" onclick="viewNotification(${notification.id})">
                        <i class="ti ti-eye"></i>
                        عرض التفاصيل
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getChannelIcon(channel) {
    const icons = {
        'telegram': 'ti-brand-telegram',
        'email': 'ti-mail',
        'browser': 'ti-browser'
    };
    return icons[channel] || 'ti-bell';
}

function getChannelName(channel) {
    const names = {
        'telegram': 'تيليجرام',
        'email': 'بريد إلكتروني',
        'browser': 'المتصفح'
    };
    return names[channel] || channel;
}

async function viewNotification(notificationId) {
    const notification = allNotifications.find(n => n.id === notificationId);
    if (!notification) return;

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">القناة</label>
                    <div class="form-control-plaintext">${getChannelName(notification.channel)}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">الحالة</label>
                    <div class="form-control-plaintext">
                        <span class="badge bg-${notification.status === 'sent' ? 'green' : 'red'}-lt">
                            ${notification.status === 'sent' ? 'تم الإرسال' : 'فشل'}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        ${notification.task_name ? `
            <div class="mb-3">
                <label class="form-label">المهمة</label>
                <div class="form-control-plaintext">${escapeHtml(notification.task_name)}</div>
            </div>
        ` : ''}
        ${notification.assistant_name ? `
            <div class="mb-3">
                <label class="form-label">المساعد</label>
                <div class="form-control-plaintext">${escapeHtml(notification.assistant_name)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label">الرسالة</label>
            <div class="message-box">${notification.message ? escapeHtml(notification.message) : 'لا توجد رسالة'}</div>
        </div>
        ${notification.error_message ? `
            <div class="mb-3">
                <label class="form-label">رسالة الخطأ</label>
                <div class="alert alert-danger">${escapeHtml(notification.error_message)}</div>
            </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label">التاريخ</label>
            <div class="form-control-plaintext">${formatDateTime(notification.create_time)}</div>
        </div>
    `;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('modal-notification'));
    modal.show();
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'Z');
    if (isNaN(date.getTime())) return '';

    const now = new Date();
    const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diff < 60) {
        if (diff < 5) return 'الآن';
        return `منذ ${diff} ثانية`;
    }

    const minutes = Math.floor(diff / 60);
    if (minutes < 60) {
        if (minutes === 1) return 'منذ دقيقة';
        if (minutes === 2) return 'منذ دقيقتين';
        return `منذ ${minutes} دقيقة`;
    }

    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
        if (hours === 1) return 'منذ ساعة';
        if (hours === 2) return 'منذ ساعتين';
        return `منذ ${hours} ساعة`;
    }

    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}
